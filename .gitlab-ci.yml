---

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

build:
  stage: build
  image: docker:19.03.15
  tags:
    - linux
    - docker
    - amd64
    - cloud
    - docker-machine
  services:
    - name: docker:19.03.15-dind
      command: ["--experimental"]
  before_script:
    - |
      echo "${CI_JOB_TOKEN}" | docker login \
      --username gitlab-ci-token \
      --password-stdin \
      "${CI_REGISTRY}"
  script:
    - docker build \
      -f Dockerfile_${R_ENVIRONMENT}_${R_VERSION}_bioc_${BIOC_VERSION}
      -t ${CI_REGISTRY_IMAGE}/${R_ENVIRONMENT}_${R_VERSION}_bioc_${BIOC_VERSION}:latest
      ./dockerfiles
    - docker push ${CI_REGISTRY_IMAGE}/${R_ENVIRONMENT}_${R_VERSION}_bioc_${BIOC_VERSION}:latest
  parallel:
    matrix:
      - R_ENVIRONMENT: ["r-ver", "rstudio", "rstudio-local", "tidyverse", "verse"]
        R_VERSION: ["4.1.0", "4.1.1"]
        BIOC_VERSION: ["3.13"]
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "schedule"
